name: POI Build

on:
  workflow_dispatch:
  push:
    branches: 
      - master
    paths:
      - 'apis/poi/**'
  pull_request:
    branches: 
      - master
    paths:
      - 'apis/poi/**'
env:
  AZURE_WEBAPP_NAME: openhackuc9203t8poi
  AZURE_WEBAPP_SLOT: staging
  
jobs:
  # build:
  #   runs-on: ubuntu-latest
  #   steps:
  #   - uses: actions/checkout@v2
  #   - name: Setup .NET Core
  #     uses: actions/setup-dotnet@v1
  #   - name: Install dependencies
  #     run: dotnet restore ./apis/poi/
  #   - name: Build
  #     run: dotnet build ./apis/poi/ --configuration Release --no-restore
  #   - name: Test
  #     run: dotnet test ./apis/poi/ --no-restore --verbosity normal
  #   - name: Issue
  #     if: ${{ failure() }}
  #     uses: JasonEtco/create-an-issue@v2
  #     env:
  #       GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  docker-build-push:  
    runs-on: ubuntu-latest
    # needs: build
    if: github.event_name != 'pull_request'
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v1
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1
    - name: Login to ACR
      uses: docker/login-action@v1
      with:
        registry: openhackuc9203t8acr.azurecr.io
        username: ${{ secrets.ACR_USER }}
        password: ${{ secrets.ACR_PASSWORD }}
    - name: Docker build
      run: docker build ./apis/poi/web/ -t openhackuc9203t8acr.azurecr.io/devopsoh/api-poi:${{github.run_number}}
    - name: Docker push
      run: docker push openhackuc9203t8acr.azurecr.io/devopsoh/api-poi:${{github.run_number}}
            
    - name: 'Deploy to Azure Web App for Container'
      uses: azure/webapps-deploy@v2
      with: 
        app-name: ${{ env.AZURE_WEBAPP_NAME }} # Replace with your app name
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_POI_STAGING  }}
        slot-name: ${{ env.AZURE_WEBAPP_SLOT }}
        images: openhackuc9203t8acr.azurecr.io/devopsoh/api-poi:${{github.run_number}}
            
